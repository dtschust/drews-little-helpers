#!/usr/bin/env node

require('dotenv').config();
const childProcess = require('child_process');
const path = require('path');
const { WebClient } = require('@slack/client');

const token = process.env.SLACK_API_TOKEN || '';
const web = new WebClient(token);

const tasks = [
	'checkUpdatesForMomo',
	'letterboxdToRSS',
	'checkUpdatesForGaryKamiya',
	'restoreFeedsOnHiatus',
	'clearOldCronLogs',
];

let someFailed = false;

const logs = [];

function log(message) {
	console.log(message);
	logs.push(message);
}

tasks.forEach((task) => {
	log(`*Executing task \`${task}\`*
`);
	const { status, stderr, stdout } = childProcess.spawnSync(path.resolve(__dirname, `./${task}`));

	if (status) {
		someFailed = true;
		log(`Error executing \`${task}\`! Error: ${status}
\`\`\`
${stderr}
\`\`\`
`);
	} else {
		if (stderr.length) {
			someFailed = true;
			log(`Error Output:
\`\`\`
${stderr.toString().trim()}
\`\`\`
`);
		}
		if (stdout.length) {
			log(`Output:
\`\`\`
${stdout.toString().trim()}
\`\`\`
`);
		}
	}
	log(`*${status ? 'âŒ' : 'âœ…'} Task \`${task}\` complete*\n\n`);
});

web.chat
	.postMessage({
		channel: process.env.CRON_LOGS_CHANNEL_ID,
		text: someFailed
			? 'âŒ: At least one hourly task failed! @drew ðŸ§µ'
			: 'âœ… Hourly Tasks completed successfully!',
		link_names: true,
	})
	.then(({ ts }) => {
		web.chat
			.postMessage({
				channel: process.env.CRON_LOGS_CHANNEL_ID,
				text: logs.join('\n'),
				thread_ts: ts,
				link_names: true,
			})
			.then(() => {
				console.log('Logs sent to Slack');
				process.exit(0);
			})
			.catch((err) => {
				console.log('Failed to send logs to Slack:', err);
				process.exit(1);
			});
	})
	.catch((err) => {
		console.log('Failed to send logs to Slack:', err);
		process.exit(1);
	});
