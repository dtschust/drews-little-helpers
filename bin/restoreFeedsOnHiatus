#!/usr/bin/env node
require('isomorphic-fetch');
require('dotenv').config();
const FeedHiatus = require('../src/mongoose-models/Feed-Hiatus');
require('../src/utils/mongoose-connect');

const feedWranglerToken = process.env.FEED_WRANGLER_ACCESS_TOKEN;
const { getDrewsHelpfulRobot } = require('../src/utils/slack');

const { sendMessageToFollowShows } = getDrewsHelpfulRobot();

const now = Date.now();

function subscribeToFeed(feed = {}) {
	const { feed_url, title, site_url } = feed;
	return fetch(
		`https://feedwrangler.net/api/v2/subscriptions/add_feed?access_token=${feedWranglerToken}&feed_url=${encodeURIComponent(
			feed_url
		)}`
	)
		.then((response) => response.json())
		.then(async ({ error, result }) => {
			if (error || result !== 'success') {
				console.error(`Error subscribing to ${title}, error: ${error}, result: ${result}`);
				return sendMessageToFollowShows(
					`Error subscribing to ${title}, error: ${error}, result: ${result}`
				);
			}
			await feed.remove();
			console.log(`Successfully resubscribed to ${title} \`(${site_url})\``);
			return sendMessageToFollowShows(
				`Back from hiatus! Resubscribed to ${title} \`(${site_url})\``
			);
		});
}

async function warnAboutPendingRestores() {
	const feedsToRestoreSoon = await FeedHiatus.find({
		end_time: { $lte: now + 86400000, $gte: now },
	});
	if (!feedsToRestoreSoon.length) {
		return true;
	}
	await sendMessageToFollowShows(
		'The following feeds are going to be restored from hiatus in the next 24 hours:'
	);

	for (const feedToRestoreSoon of feedsToRestoreSoon) {
		const { title, feed_id, end_time, site_url } = feedToRestoreSoon;

		const attachment = {
			fallback: 'TODO',
			callback_id: `${feed_id}_${end_time}`,
			actions: [
				{
					name: 'snoozeFeed',
					text: 'Snooze feed for...',
					type: 'select',
					options: [1, 2, 4, 8].map((weeksToSnooze) => {
						const newEndTime = end_time + weeksToSnooze * 604800000;
						return {
							text: `Snooze ${weeksToSnooze} week${weeksToSnooze === 1 ? '' : 's'}`,
							value: JSON.stringify({
								feed_id,
								end_time: newEndTime,
								title: encodeURIComponent(title),
							}),
						};
					}),
				},
				{
					name: `unsubscribeFeed ${feed_id}`,
					text: `Unsubscribe`,
					type: 'button',
					style: 'danger',
					value: JSON.stringify({
						feed_id,
						title: encodeURIComponent(title),
					}),
					confirm: {
						title: 'Are you sure?',
						text: `Are you sure you would like to permanently unsubscribe from *${title}*?`,
						ok_text: 'Yes',
						dismiss_text: 'No',
					},
				},
				{
					name: `dismiss ${feed_id}`,
					text: `OK`,
					type: 'button',
					style: 'primary',
					value: feed_id,
				},
			],
		};
		await sendMessageToFollowShows(`*${title}* \`(${site_url})\``, {
			attachments: [attachment],
		});
	}

	return true;
}

async function main() {
	await warnAboutPendingRestores();

	// This will find and restore all hiatus feeds
	// const feedsToRestore = await FeedHiatus.find();
	const feedsToRestore = await FeedHiatus.find({ end_time: { $lte: now } });

	if (!feedsToRestore.length) {
		console.log('No feeds to restore from hiatus');
	}

	await Promise.all(
		feedsToRestore.map(async (feed) => {
			await subscribeToFeed(feed);
		})
	);
}

main().then(process.exit);
